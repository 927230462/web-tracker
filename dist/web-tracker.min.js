var webTracker=function(){function h(e){return(""+e).split(".")[0]}function r(e){"complete"===document.readyState?e():window.addEventListener("load",e)}let t=e=>{console.log("%c "+e,"color:red")};let n=new class{constructor(){this.xhr=new XMLHttpRequest}init(e){this.appId=e.appId,this.host=e.host,this.version=e.version,this.project=e.host,this.logstore=e.host,this.url=`https://${e.project}.${e.host}/logstores/${e.logstore}/track`}initData(e={}){var t,o={...{appId:this.appId,version:this.version,pageTitle:document.title,pageUrl:location.href,timestamp:Date.now(),userAgent:navigator.userAgent},...e};for(t in o)null==o[t]?o[t]="":"number"==typeof o[t]&&(o[t]=""+o[t]),"[object Object]"===Object.prototype.toString.call(o[t])&&(o[t]=JSON.stringify(o[t]));return o}validate(e){return e.appId?e.version?e.logType?e.logCode?!!e.logName||(t("请先设置目标对象名称[logName]"),!1):(t("请先设置目标对象代码[logCode]"),!1):(t("请先设置项目类型[logType]"),!1):(t("请先设置项目版本号[version]"),!1):(t("请先设置项目代码[appId]"),!1)}send(e={},t){var o=e.method;switch(delete e.method,o){case"GET":this.sendGet(e,t);break;case"IMG":this.sendImg(e,t);break;default:this.sendPost(e,t)}}sendPost(e={},t){e=JSON.stringify({__logs__:[e]});this.xhr.open("POST",this.url,!0),this.xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),this.xhr.setRequestHeader("x-log-apiversion","0.6.0"),this.xhr.setRequestHeader("x-log-bodyrawsize",e.length),this.xhr.onload=function(){(200<=this.status&&this.status<=300||304==this.status)&&t&&t()},this.xhr.onerror=function(e){t&&t(),console.log("error",e)},this.xhr.send(e)}sendGet(t={},o){let n="";Object.keys(t).forEach(function(e){n+="&"+e+"="+t[e]});var e=`https://${this.project}.${this.host}/logstores/${this.logstore}/track_ua.gif?APIVersion=0.6.0`+n;this.xhr.open("GET",e,!0),this.xhr.onload=function(){(200<=this.status&&this.status<=300||304==this.status)&&o&&o()},this.xhr.onerror=function(e){o&&o(),console.log("error",e)},this.xhr.send()}sendImg(t={},o){var n="",e=(Object.keys(t).forEach(function(e){n+="&"+e+"="+t[e]}),document.createElement("img"));e.setAttribute("class","img-responsive"),e.src=`https://${this.project}.${this.host}/logstores/${this.logstore}/track_ua.gif?APIVersion=0.6.0`+n,e.onload=()=>{o&&o()},e.onerror=e=>{o&&o(),console.log("error",e)}}};let m=new class{constructor(){this.state="NULL",this.list=[],this.timer=null}excute(){0===this.list.length?this.state="NULL":(this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{var e=this.list.shift();this.state="RUNING",n.send(e.data,()=>{this.state="NULL",e.callback&&"function"==typeof e.callback&&e.callback(),this.excute()})},1e3))}run(e,t){let o=n.initData(e);if(n.validate(o)){if(o.message)if(0<=this.list.findIndex(e=>e.data.message===o.message))return;this.list.push({data:o,callback:t}),"RUNING"!==this.state&&this.excute()}}},l;["click","pointerdown","touchstart","mousedown","keydown","mouseover"].forEach(e=>{document.addEventListener(e,e=>{l=e},{capture:!0,passive:!0})});let s=function(e){return e.reverse().filter(function(e){return e!==window&&e!==document}).map(function(e){e=e.id?"#"+e.id:e.className&&"string"==typeof e.className?"."+e.className.split(" ").filter(function(e){return!!e}).join("."):e.nodeName;return e}).join(" ")};function c(e){if(Array.isArray(e))return s(e);for(var t=[],o=e;o;)t.push(o),o=o.parentNode;return s(t)}function i(e){e=e.id?"#"+e.id:e.className&&"string"==typeof e.className?"."+e.className.split(" ").filter(function(e){return!!e}).join("."):e.nodeName.toLowerCase();return e}class e{constructor(){this.logType={JS_ERROR:!0,CONSOLE_ERROR:!0,XHR_ERROR:{LOAD:!0,ERROR:!0,ABORT:!1},PV:!1,PERFORMANCE:!1,TIME_ON_PAGE:!1,LONG_TASK:!1,BLANK_SCREEN:!1}}install(e,t){this.init(t),e.prototype.$webTracker=this}init(e){this.logType=function(e,t){for(var o in t)e[o]=t[o];return e}(this.logType,(e=e||{}).logType||{}),e.logType=this.logType,this.config=e,n.init(this.config),this._init()}send(e,t){m.run(e,t)}_init(){{var o=this.logType.XHR_ERROR,e=window.XMLHttpRequest;let r=e.prototype.open,t=(e.prototype.open=function(e,t,o,n,s){return t.match(/logstores/)||t.match(/sockjs/)||(this.logData={method:e,url:t,async:o,user:n,password:s}),r.apply(this,arguments)},e.prototype.send);e.prototype.send=function(i){if(this.logData){let r=Date.now();var e=s=>e=>{var t,o=Date.now()-r,n=this.status;/^[2|3].{2}$/.test(n)||(t=this.statusText,m.run({logType:"monitor",logCode:"XHR_ERROR",logName:"接口错误",elementType:"page",eventType:s,pathname:this.logData.url,status:n+"-"+t,duration:""+o,response:this.response?JSON.stringify(this.response):"",params:i||""}))};o&&o.LOAD&&this.addEventListener("load",e("LOAD"),!1),o&&o.ERROR&&this.addEventListener("error",e("ERROR"),!1),o&&o.ABORT&&this.addEventListener("abort",e("ABORT"),!1)}t.apply(this,arguments)}}var t;if(this.logType&&this.logType.JS_ERROR&&(window.addEventListener("error",function(e){var t=l;e.target&&(e.target.src||e.target.href)?m.run({logType:"monitor",logCode:"RESOURCE_ERROR",logName:"资源加载错误",filename:e.target.src||e.target.href,tagName:e.target.tagName,elementType:c(e.path||e.target)}):m.run({logType:"monitor",logCode:"JS_ERROR",logName:"JS错误",message:e.message,filename:e.filename,position:(e.lineno||0)+":"+(e.colno||0),stack:e.error&&e.error.stack,elementType:t?c(t.path||t.target):""})},!0),window.addEventListener("unhandledrejection",function(e){var t=l;let o="",n=0,s=0,r="",i="";"string"==typeof e.reason?o=e.reason:"object"==typeof e.reason&&(o=e.reason.message);var a,e=e.reason;"object"==typeof e&&e.stack&&((a=e.stack.match(/at\s+(.+):(\d+):(\d+)/))&&(r=a[1],n=a[2],s=a[3]),i=e.stack),m.run({logType:"monitor",logCode:"PROMISE_ERROR",logName:"Promise错误",elementType:t?c(t.path||t.target):"",message:o,filename:r,position:n+":"+s,stack:i})},!0)),this.logType&&this.logType.CONSOLE_ERROR&&(console.error=(t=console.error,function(e){"string"==typeof e?m.run({logType:"monitor",type:"ERROR",logCode:"CONSOLE_ERROR",logName:"控制台错误",message:e,elementType:"page"}):"object"==typeof e&&m.run({logType:"monitor",logCode:"CONSOLE_ERROR",logName:"控制台错误",message:e.message,stack:e.stack,elementType:"page"}),t.call(console,e)})),this.logType&&this.logType.BLANK_SCREEN){let t=["body","html","#app"],n=0;function s(e){e=i(e);0<=t.indexOf(e)&&n++}r(function(){var t,o,e;for(let e=1;e<=9;e++)t=document.elementsFromPoint(window.innerWidth*e/10,window.innerHeight/2),o=document.elementsFromPoint(window.innerWidth/2,window.innerHeight*e/10),s(t[0]),s(o[0]);0<=n&&(e=document.elementsFromPoint(window.innerWidth/2,window.innerHeight/2),m.run({logType:"monitor",logCode:"BLANK_SCREEN",logName:"白屏",emptyPoints:""+n,screen:window.screen.width+"x"+window.screen.height,viewPoint:window.innerWidth+"x"+window.innerHeight,elementType:i(e[0])}))})}if(this.logType&&this.logType.LONG_TASK&&new PerformanceObserver(e=>{e.getEntries().forEach(e=>{100<e.duration&&requestIdleCallback(()=>{m.run({logType:"monitor",logCode:"LONG_TASK",logName:"卡顿",eventType:lastEvent.type,startTime:h(e.startTime),duration:h(e.duration)})})})}).observe({entryTypes:["longtask"]}),this.logType&&this.logType.PERFORMANCE){let g,d;new PerformanceObserver((e,t)=>{e=e.getEntries();g=e[0],t.disconnect()}).observe({entryTypes:["element"]}),new PerformanceObserver((e,t)=>{e=e.getEntries(),e=e[e.length-1];d=e,t.disconnect()}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(function(e,t){var o,n,e=e.getEntries()[0];e&&(o=e.processingStart-e.startTime,n=e.duration,0<e||0<n)&&m.run({logType:"monitor",logCode:"PERFORMANCE_FIRST_INPUT_DELAY",logName:"第一输入延迟",elementType:"page",inputDelay:o?h(o):0,duration:n?h(n):0,startTime:e.startTime}),t.disconnect()}).observe({type:"first-input",buffered:!0}),r(function(){setTimeout(()=>{var{fetchStart:e,connectStart:t,connectEnd:o,requestStart:n,responseStart:s,responseEnd:r,domLoading:i,domInteractive:a,domContentLoadedEventStart:l,domContentLoadedEventEnd:c,loadEventStart:p}=performance.timing,o=(log.send({logType:"monitor",logCode:"PERFORMANCE_TMING",logName:"性能计时",elementType:"page",connectTime:o-t,ttfbTime:s-n,responseTime:r-s,parseDOMTime:p-i,domContentLoadedTime:c-l,timeToInteractive:a-e,loadTime:p-e}),performance.getEntriesByName("first-paint")[0]),t=performance.getEntriesByName("first-contentful-paint")[0];m.run({logType:"monitor",logCode:"PERFORMANCE_PAINT",logName:"首次绘制",elementType:"page",firstPaint:o?h(o.startTime):0,firstContentPaint:t?h(t.startTime):0,firstMeaningfulPaint:g?h(g.startTime):0,largestContentfulPaint:d?h(d.renderTime||d.loadTime):0})},3e3)})}if(this.logType&&this.logType.PV){e=navigator.connection;m.run({logType:"monitor",logCode:"PV",logName:"PV",elementType:"page",effectiveType:e.effectiveType,rtt:e.rtt,screen:window.screen.width+"x"+window.screen.height});let t=Date.now();window.addEventListener("unload",()=>{var e=Date.now()-t;m.run({logType:"monitor",logCode:"STAY_TIME",logName:"在线时长",elementType:"page",stayTime:e})},!1)}}}return new e}();
